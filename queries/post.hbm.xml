<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping>
  <sql-query name="app.post.search.customer">
    <![CDATA[
      select
        "ID" AS "postId",
        "SERVICE_ID" AS "serviceId",
        "VEHICLE_ID" AS "vehicleId",
        "ACTIVITY_DATE_TIME_FROM" AS "activityFromDate",
        "ACTIVITY_DATE_TIME_TO" AS "activityToDate",
        "SOURCE" AS "source",
        "DESTINATION" AS "destination",
        "OTHER" AS "otherInfo",
        "STATUS" AS "status",
		    "POST_TITLE" AS "postTitle",
			"BID" AS bid,
			"BID_DATE_TIME_TO" AS bidEndDate,
        COALESCE(p2."requestCount",0) AS "requestCount",
		COALESCE(p3."amount",0) AS "amount"
      from "T_POST"
      LEFT JOIN (
    		  	SELECT
    		  		count(*) AS "requestCount",
    		  		"POST_ID" as "postId"
    			FROM "T_POST_REQUEST"
    			WHERE
    			"DEL_FLG" = 0
    			GROUP BY "POST_ID"
    	  ) p2
    	  ON(
    		  "ID" = p2."postId"
    	  )
		 LEFT JOIN(
			  SELECT "POST_ID" as "postId",  MIN("AMOUNT") as "amount" FROM "T_POST_BID"
			  WHERE
			 "DEL_FLG" = 0
			  GROUP BY "POST_ID")
			  p3
			  ON (
			  "ID" = p3."postId"
			  )

      where
        "DEL_FLG" = 0
        AND "USER_ID" = :userId
        AND "SERVICE_ID" = COALESCE(CAST(:serviceId AS TEXT),"SERVICE_ID")
        AND "VEHICLE_ID" = COALESCE(CAST(:vehicleId AS TEXT),"VEHICLE_ID")
        AND ("SOURCE" ilike CONCAT('%',COALESCE(CAST(:source AS TEXT),"SOURCE"),'%')
            OR "DESTINATION" ilike CONCAT('%',COALESCE(CAST(:destination AS TEXT),"DESTINATION"),'%')
        )
      ORDER BY "ACTIVITY_DATE_TIME_TO" DESC
    ]]>
  </sql-query>
  <sql-query name="app.post.search.provider">
    <![CDATA[
        SELECT
          "ID" AS "postId",
          "SERVICE_ID" AS "serviceId",
          "VEHICLE_ID" AS "vehicleId",
          "ACTIVITY_DATE_TIME_FROM" AS "activityFromDate",
          "ACTIVITY_DATE_TIME_TO" AS "activityToDate",
          "SOURCE" AS "source",
          "DESTINATION" AS "destination",
          "OTHER" AS "otherInfo",
          "STATUS" AS "status",
          "POST_TITLE" AS "postTitle",
          "BID" AS bid,
          "BID_DATE_TIME_TO" AS bidEndDate,
          COALESCE(p2."requestCount",0) AS "requestCount",
          COALESCE(p3."amount",0) AS "currentBidAmount",
          COALESCE(p4."amount",0) AS "myCurrentBidAmount"
        FROM "T_POST"
        LEFT JOIN (
              SELECT
                count(*) AS "requestCount",
                "POST_ID" as "postId"
              FROM "T_POST_REQUEST"
              WHERE
                "DEL_FLG" = 0
                AND "REQUEST_USER_ID" = :requestUserId
              GROUP BY "POST_ID"
          ) p2
          ON(
            "ID" = p2."postId"
          )
        LEFT JOIN(
          SELECT
            "POST_ID" as "postId",
            MIN("AMOUNT") as "amount"
          FROM
            "T_POST_BID"
          WHERE
            "DEL_FLG" = 0
          GROUP BY "POST_ID"
        ) p3
        ON (
          "ID" = p3."postId"
        )
        LEFT JOIN (
          SELECT
            userPostRequest."POST_ID" as "postId",
            userPostRequest."AMOUNT" as "amount"
          FROM (
            SELECT
              *
            FROM
              "T_POST_BID"
            WHERE
              "DEL_FLG" = 0
              AND "REQUEST_USER_ID" = :requestUserId
            ORDER BY
              "INS_DT" DESC
            LIMIT 1
          ) AS userPostRequest
          WHERE
            userPostRequest."DEL_FLG" = 0
        ) p4
        ON (
          "ID" = p4."postId"
        )
        where
          "DEL_FLG" = 0
          AND (
    			  "STATUS" in ('NEW')
    		  	 OR ("STATUS" in('ACCEPTED') AND "SERVICE_PROVIDER_USER" = :requestUserId)
         )
          AND "SERVICE_ID" = COALESCE(CAST(:serviceId AS TEXT),"SERVICE_ID")
          AND "VEHICLE_ID" = COALESCE(CAST(:vehicleId AS TEXT),"VEHICLE_ID")
          AND ("SOURCE" ilike CONCAT('%',COALESCE(CAST(:source AS TEXT),"SOURCE"),'%')
              OR "DESTINATION" ilike CONCAT('%',COALESCE(CAST(:destination AS TEXT),"DESTINATION"),'%')
          )
        ORDER BY "ACTIVITY_DATE_TIME_TO" DESC
    ]]>
  </sql-query>
  <sql-query name="app.post.create">
    <![CDATA[
    INSERT INTO "T_POST"(
        "ID",
        "USER_ID",
        "SERVICE_ID",
        "VEHICLE_ID",
        "SOURCE",
        "DESTINATION",
        "OTHER",
        "POST_TITLE",
        "STATUS",
        "DEL_FLG",
        "INS_DT",
        "INS_BY",
        "ACTIVITY_DATE_TIME_FROM",
        "ACTIVITY_DATE_TIME_TO",
        "BID_DATE_TIME_FROM",
        "BID_DATE_TIME_TO",
        "BID"
      )
      VALUES (
        :id,
        :userId,
        :serviceId,
        concat(',', :vehicleId, ','),
        :source,
        :destination,
        :otherInfo,
        :postTitle,
        :status,
        0,
        CURRENT_TIMESTAMP,
        :serviceCode,
        {SQL_PART}
        :bid
      )
    ]]>
  </sql-query>
  <sql-query name="app.post.update">
    <![CDATA[
      UPDATE "T_POST"
      SET "SERVICE_ID" = :serviceId,
        "VEHICLE_ID" = :vehicleId,
        "ACTIVITY_DATE_TIME_FROM" = :activityFromDate,
        "ACTIVITY_DATE_TIME_TO" = :activityToDate,
        "SOURCE" = :source,
        "DESTINATION" = :destination,
        "OTHER" = :otherInfo,
        "UPD_DT" = CURRENT_TIMESTAMP,
        "UPD_BY" = :serviceCode
      WHERE
        "ID" = :postId
        AND "USER_ID" = :userId
    ]]>
  </sql-query>
  <sql-query name="app.post.update.status">
    <![CDATA[
      UPDATE "T_POST"
      SET
        "STATUS" = :status,
        "UPD_DT" = CURRENT_TIMESTAMP,
        "UPD_BY" = :serviceCode,
        "SERVICE_PROVIDER_USER" = CASE WHEN :status = 'ACCEPTED' THEN :requestUserId ELSE null END
      WHERE
        "ID" = :postId
        AND "USER_ID" = :userId
    ]]>
  </sql-query>
  <sql-query name="app.post.delete">
    <![CDATA[
      UPDATE "T_POST"
      SET "DEL_FLG" = 1,
          "STATUS" = 'DELETED',
          "UPD_DT" = CURRENT_TIMESTAMP,
          "UPD_BY" = :serviceCode
      WHERE
        "ID" = :postId
        AND "USER_ID" = :userId
    ]]>
  </sql-query>
  <sql-query name="app.post.create.request">
    <![CDATA[
      INSERT INTO "T_POST_REQUEST"(
      	"ID",
      	"POST_ID",
      	"REQUEST_USER_ID",
        "STATUS",
      	"DEL_FLG",
      	"INS_DT",
      	"INS_BY"
      )
      VALUES (
      	:id,
      	:postId,
      	:userId,
        :status,
      	0,
      	CURRENT_TIMESTAMP,
      	:serviceCode
      )
    ]]>
  </sql-query>
  <sql-query name="app.post.delete.request">
    <![CDATA[
      UPDATE "T_POST_REQUEST"
      SET "DEL_FLG" = 1,
          "STATUS" = 'DELETED',
          "UPD_DT" = CURRENT_TIMESTAMP,
          "UPD_BY" = :serviceCode
      WHERE
        "POST_ID" = :postId
        AND "REQUEST_USER_ID" = :userId
    ]]>
  </sql-query>
  <sql-query name="app.post.get.request.count">
    <![CDATA[
      SELECT COUNT(*) AS "requestCount"
      FROM
        "T_POST_REQUEST"
      WHERE
        "POST_ID" = :postId
        AND "DEL_FLG" = 0
    ]]>
  </sql-query>
  <sql-query name="app.post.get.request">
    <![CDATA[
        SELECT
           postReq."POST_ID" AS "postId",
           post."STATUS" AS "status",
           postReq."INS_DT" AS "requestTime",
           postReq."ID" AS "requestID",
           postReq."REQUEST_USER_ID" AS "requestUserId",
           mUser."FIRST_NAME" || ' ' || "LAST_NAME" AS "requestUserName",
           3 AS "review",
           'Pune' AS "location",
           '3' AS "experience",
           mUser."MOBILE" AS "phone",
           mUser."EMAIL" AS "email",
           null AS "images",
           post."SERVICE_PROVIDER_USER" AS "serviceProviderId",
           userPostRequest."amount" AS "bidAmount"
         FROM
           "T_POST_REQUEST" AS postReq
         JOIN "T_POST" AS post
         ON(
           post."ID" = postReq."POST_ID"
         )
         JOIN "M_USER" AS mUser
         ON (
             mUser."USER_ID" = postReq."REQUEST_USER_ID"
         )
         LEFT JOIN (
            SELECT
              tPostBid."POST_ID" as "postId",
              tPostBid."AMOUNT" as "amount",
              tPostBid."REQUEST_USER_ID"
            FROM "T_POST_BID" AS tPostBid
            JOIN(
              SELECT
                "REQUEST_USER_ID",
                "POST_ID",
                MAX("INS_DT") AS "INS_DT"
              FROM
                "T_POST_BID"
              WHERE
                "DEL_FLG" = 0
              GROUP BY
                "REQUEST_USER_ID",
                "POST_ID"
            ) as latestBidData
            ON(
              latestBidData."POST_ID" = tPostBid."POST_ID"
              AND latestBidData."REQUEST_USER_ID" = tPostBid."REQUEST_USER_ID"
              AND latestBidData."INS_DT" = tPostBid."INS_DT"
            )
          ) AS userPostRequest
          ON (
            post."ID" = userPostRequest."postId"
            AND postReq."REQUEST_USER_ID" = userPostRequest."REQUEST_USER_ID"
          )
        WHERE
          postReq."POST_ID" = CASE WHEN :postId in ('<NA>') THEN "POST_ID" ELSE :postId END
          AND postReq."DEL_FLG" = 0
          AND mUser."DEL_FLG" = 0
          AND mUser."AC_TYP" = 2
          AND postReq."STATUS" = 'NEW'
    ]]>
  </sql-query>
</hibernate-mapping>
